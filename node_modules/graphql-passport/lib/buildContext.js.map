{"version":3,"sources":["../src/buildContext.ts"],"names":["promisifiedAuthentication","req","res","name","options","Promise","resolve","reject","done","err","user","info","authFn","passport","authenticate","promisifiedLogin","login","buildCommonContext","additionalContext","isAuthenticated","isUnauthenticated","getUser","strategyName","Error","logout","buildContext","contextParams","connection","payload","context","sharedContext"],"mappings":";;;;;;;AACA;;;;AADA;AAMA,MAAMA,yBAAyB,GAAG,CAChCC,GADgC,EAEhCC,GAFgC,EAGhCC,IAHgC,EAIhCC,OAJgC,KAMhC,IAAIC,OAAJ,CAAgD,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACnE,QAAMC,IAAI,GAAG,CAACC,GAAD,EAAyBC,IAAzB,EAA2DC,IAA3D,KAA+F;AAC1G,QAAIF,GAAJ,EAASF,MAAM,CAACE,GAAD,CAAN,CAAT,KACKH,OAAO,CAAC;AAAEI,MAAAA,IAAF;AAAQC,MAAAA;AAAR,KAAD,CAAP;AACN,GAHD;;AAKA,QAAMC,MAAM,GAAGC,kBAASC,YAAT,CAAsBX,IAAtB,EAA4BC,OAA5B,EAAqCI,IAArC,CAAf;;AACA,SAAOI,MAAM,CAACX,GAAD,EAAMC,GAAN,CAAb;AACD,CARD,CANF;;AAgBA,MAAMa,gBAAgB,GAAG,CACvBd,GADuB,EAEvBS,IAFuB,EAGvBN,OAHuB,KAKvB,IAAIC,OAAJ,CAAkB,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACrC,QAAMC,IAAI,GAAIC,GAAD,IAA4B;AACvC,QAAIA,GAAJ,EAASF,MAAM,CAACE,GAAD,CAAN,CAAT,KACKH,OAAO;AACb,GAHD;;AAKAL,EAAAA,GAAG,CAACe,KAAJ,CAAUN,IAAV,EAAgBN,OAAhB,EAAyBI,IAAzB;AACD,CAPD,CALF;;AA8BA,MAAMS,kBAAkB,GAAG,CACzBhB,GADyB,EAEzBiB,iBAFyB,MAGrB;AACJC,EAAAA,eAAe,EAAE,MAAMlB,GAAG,CAACkB,eAAJ,EADnB;AAEJC,EAAAA,iBAAiB,EAAE,MAAMnB,GAAG,CAACmB,iBAAJ,EAFrB;AAGJC,EAAAA,OAAO,EAAE,MAAMpB,GAAG,CAACS,IAHf;AAIJI,EAAAA,YAAY,EAAGQ,YAAD,IAA0B;AACtC,UAAM,IAAIC,KAAJ,CAAW,iBAAgBD,YAAa,qCAAxC,CAAN;AACD,GANG;AAOJN,EAAAA,KAAK,EAAE,MAAM;AACX,UAAM,IAAIO,KAAJ,CAAU,mCAAV,CAAN;AACD,GATG;AAUJC,EAAAA,MAAM,EAAE,MAAM;AACZ,UAAM,IAAID,KAAJ,CAAU,mCAAV,CAAN;AACD,GAZG;AAaJtB,EAAAA,GAbI;AAcJ,KAAGiB;AAdC,CAHqB,CAA3B;;AA2BA;AACA;AACA,MAAMO,YAAY,GAChBC,aADmB,IAES;AAC5B,QAAM;AACJzB,IAAAA,GADI;AACC;AACLC,IAAAA,GAFI;AAEC;AACLyB,IAAAA,UAHI;AAGQ;AACZC,IAAAA,OAJI;AAIK;AACT,OAAGV;AALC,MAMFQ,aANJ;;AAQA,MAAIC,UAAJ,EAAgB;AACd,WAAOV,kBAAkB,CAAiBU,UAAU,CAACE,OAAX,CAAmB5B,GAApC,EAAyCiB,iBAAzC,CAAzB;AACD,GAX2B,CAa5B;;;AACA,QAAMY,aAAa,GAAGb,kBAAkB,CAAiBhB,GAAjB,EAA6BiB,iBAA7B,CAAxC;AACA,SAAO,EACL,GAAGY,aADE;AAELhB,IAAAA,YAAY,EAAE,CAACX,IAAD,EAAeC,OAAf,KAAgDJ,yBAAyB,CAACC,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAiBC,OAAjB,CAFlF;AAGLY,IAAAA,KAAK,EAAE,CAACN,IAAD,EAAuBN,OAAvB,KAAwDW,gBAAgB,CAAiBd,GAAjB,EAAsBS,IAAtB,EAA4BN,OAA5B,CAH1E;AAILoB,IAAAA,MAAM,EAAE,MAAMvB,GAAG,CAACuB,MAAJ,EAJT;AAKLtB,IAAAA;AALK,GAAP;AAOD,CAxBD;;eA0BeuB,Y","sourcesContent":["/* eslint-disable max-len */\nimport passport, { AuthenticateOptions } from 'passport';\nimport express from 'express';\nimport { ExecutionParams } from 'subscriptions-transport-ws';\nimport { AuthenticateReturn, InfoArgument } from './types';\n\nconst promisifiedAuthentication = <UserObjectType extends Express.User>(\n  req: express.Request,\n  res: express.Response,\n  name: string,\n  options: AuthenticateOptions,\n) =>\n  new Promise<AuthenticateReturn<UserObjectType>>((resolve, reject) => {\n    const done = (err: Error | undefined, user: UserObjectType | undefined, info?: InfoArgument | undefined) => {\n      if (err) reject(err);\n      else resolve({ user, info });\n    };\n\n    const authFn = passport.authenticate(name, options, done);\n    return authFn(req, res);\n  });\n\nconst promisifiedLogin = <UserObjectType extends Express.User>(\n  req: express.Request,\n  user: UserObjectType,\n  options?: AuthenticateOptions,\n) =>\n  new Promise<void>((resolve, reject) => {\n    const done = (err: Error | undefined) => {\n      if (err) reject(err);\n      else resolve();\n    };\n\n    req.login(user, options, done);\n  });\n\ninterface CommonRequest<UserObjectType extends Express.User>\n  extends Pick<Context<UserObjectType>, 'isAuthenticated' | 'isUnauthenticated'> {\n  user?: UserObjectType;\n}\n\nexport interface Context<UserObjectType extends Express.User> {\n  isAuthenticated: () => boolean;\n  isUnauthenticated: () => boolean;\n  getUser: () => UserObjectType;\n  authenticate: (strategyName: string, options?: object) => Promise<AuthenticateReturn<UserObjectType>>;\n  login: (user: UserObjectType, options?: object) => Promise<void>;\n  logout: () => void;\n  res?: express.Response;\n  req: CommonRequest<UserObjectType>;\n}\n\nconst buildCommonContext = <UserObjectType extends Express.User>(\n  req: CommonRequest<UserObjectType>,\n  additionalContext: {},\n) => ({\n  isAuthenticated: () => req.isAuthenticated(),\n  isUnauthenticated: () => req.isUnauthenticated(),\n  getUser: () => req.user,\n  authenticate: (strategyName: string) => {\n    throw new Error(`Authenticate (${strategyName}) not implemented for subscriptions`);\n  },\n  login: () => {\n    throw new Error('Not implemented for subscriptions');\n  },\n  logout: () => {\n    throw new Error('Not implemented for subscriptions');\n  },\n  req,\n  ...additionalContext,\n});\n\nexport interface ContextParams {\n  req: express.Request;\n  res: express.Response;\n  connection?: ExecutionParams;\n  payload?: unknown;\n}\n\n// function buildContext(contextParams: RegularContextParams): Context;\n// function buildContext(contextParams: SubscriptionContextParams): SubscriptionContext;\nconst buildContext = <UserObjectType extends Express.User, R extends ContextParams = ContextParams>(\n  contextParams: R,\n): Context<UserObjectType> => {\n  const {\n    req, // set for queries and mutations\n    res, // set for queries and mutations\n    connection, // set for subscriptions\n    payload, // set for subscriptions\n    ...additionalContext\n  } = contextParams;\n\n  if (connection) {\n    return buildCommonContext<UserObjectType>(connection.context.req, additionalContext);\n  }\n\n  // The UserObject is without the any in conflict: \"'User' is not assignable to type 'UserObjectType'\"\n  const sharedContext = buildCommonContext<UserObjectType>(req as any, additionalContext);\n  return {\n    ...sharedContext,\n    authenticate: (name: string, options: AuthenticateOptions) => promisifiedAuthentication(req, res, name, options),\n    login: (user: UserObjectType, options: AuthenticateOptions) => promisifiedLogin<UserObjectType>(req, user, options),\n    logout: () => req.logout(),\n    res,\n  };\n};\n\nexport default buildContext;\n"],"file":"buildContext.js"}